<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Loyalty Cards Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .pass {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .fail {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ User Loyalty Cards Fix Test</h1>
        <p>This test will verify that the user_loyalty_cards table fix is working correctly.</p>
        
        <div>
            <button onclick="runTests()" id="testBtn">Run Tests</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div id="results"></div>
        <div id="summary"></div>
    </div>

    <script>
        // Test configuration - Update these with your actual Supabase credentials
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Replace with your actual URL
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your actual anon key
        
        // Instructions:
        // 1. Replace 'YOUR_SUPABASE_URL' with your actual Supabase URL
        // 2. Replace 'YOUR_SUPABASE_ANON_KEY' with your actual anon key
        // 3. Save this file and open it in your browser
        // 4. Click "Run Tests" to verify the fix worked
        
        let testResults = {
            passed: 0,
            failed: 0,
            tests: []
        };

        function addResult(testName, passed, message = '') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            
            const status = passed ? '‚úÖ PASS' : '‚ùå FAIL';
            resultDiv.innerHTML = `<strong>${status}: ${testName}</strong>${message ? `<br>${message}` : ''}`;
            
            resultsDiv.appendChild(resultDiv);
            
            testResults.tests.push({ name: testName, passed, message });
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const total = testResults.passed + testResults.failed;
            const successRate = total > 0 ? ((testResults.passed / total) * 100).toFixed(1) : 0;
            
            let summaryClass = 'warning';
            let summaryText = '';
            
            if (testResults.failed === 0 && testResults.passed > 0) {
                summaryClass = 'success';
                summaryText = `
                    <h3>üéâ ALL TESTS PASSED!</h3>
                    <p>The user_loyalty_cards fix is working correctly.</p>
                    <p><strong>Success Rate:</strong> ${successRate}% (${testResults.passed}/${total})</p>
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>‚úÖ Database fix is working correctly</li>
                        <li>‚úÖ Frontend components should work without issues</li>
                        <li>‚úÖ Users can create loyalty cards successfully</li>
                    </ul>
                `;
            } else if (testResults.failed > 0) {
                summaryClass = 'error';
                summaryText = `
                    <h3>‚ö†Ô∏è Some Tests Failed</h3>
                    <p><strong>Success Rate:</strong> ${successRate}% (${testResults.passed}/${total})</p>
                    <p><strong>Failed Tests:</strong></p>
                    <ul>
                        ${testResults.tests.filter(test => !test.passed).map(test => `<li>${test.name}: ${test.message}</li>`).join('')}
                    </ul>
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>1. Apply the database migration: 20250115_final_user_loyalty_cards_fix.sql</li>
                        <li>2. Re-run this test to verify the fix</li>
                        <li>3. Check Supabase dashboard for any permission issues</li>
                    </ul>
                `;
            } else {
                summaryText = `
                    <h3>‚ÑπÔ∏è No Tests Run Yet</h3>
                    <p>Click "Run Tests" to start testing the user_loyalty_cards fix.</p>
                `;
            }
            
            summaryDiv.className = `summary ${summaryClass}`;
            summaryDiv.innerHTML = summaryText;
        }

        async function testDatabaseConnection() {
            try {
                if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    addResult('Database Connection', false, 'Please update SUPABASE_URL and SUPABASE_ANON_KEY in the script');
                    return false;
                }

                // Create Supabase client
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient.from('user_loyalty_cards').select('count').limit(1);
                addResult('Database Connection', !error, error ? error.message : 'Connected successfully');
                return !error;
            } catch (err) {
                addResult('Database Connection', false, err.message);
                return false;
            }
        }

        async function testTableStructure() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient
                    .from('user_loyalty_cards')
                    .select('id, user_id, loyalty_number, full_name, email, phone, is_active, created_at, updated_at')
                    .limit(1);
                
                addResult('Table Structure', !error, error ? error.message : 'All expected columns present');
                return !error;
            } catch (err) {
                addResult('Table Structure', false, err.message);
                return false;
            }
        }

        async function testLoyaltyNumberGeneration() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient.rpc('generate_loyalty_number', { 
                    user_email: 'test@example.com' 
                });
                
                const hasValidNumber = data && typeof data === 'string' && data.length >= 8;
                addResult('Loyalty Number Generation', hasValidNumber, 
                    hasValidNumber ? `Generated: ${data}` : `Error: ${error?.message || 'Invalid response'}`);
                
                return hasValidNumber ? data : null;
            } catch (err) {
                addResult('Loyalty Number Generation', false, err.message);
                return null;
            }
        }

        async function testSchemaCompatibility() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test public schema
                const { data: publicData, error: publicError } = await supabaseClient
                    .from('user_loyalty_cards')
                    .select('count')
                    .limit(1);

                // Test api schema
                const { data: apiData, error: apiError } = await supabaseClient
                    .schema('api')
                    .from('user_loyalty_cards')
                    .select('count')
                    .limit(1);

                const publicWorks = !publicError;
                const apiWorks = !apiError;
                
                addResult('Public Schema Access', publicWorks, publicError ? publicError.message : 'Accessible');
                addResult('API Schema Access', apiWorks, apiError ? apiError.message : 'Accessible');
                
                return publicWorks || apiWorks;
            } catch (err) {
                addResult('Schema Compatibility', false, err.message);
                return false;
            }
        }

        async function testRLSPolicies() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient
                    .from('user_loyalty_cards')
                    .select('*')
                    .limit(1);

                const isRLSWorking = !error || error.code === 'PGRST116';
                
                addResult('RLS Policies', isRLSWorking, 
                    error && error.code !== 'PGRST116' ? `RLS Error: ${error.message}` : 'RLS properly configured');
                
                return isRLSWorking;
            } catch (err) {
                addResult('RLS Policies', false, err.message);
                return false;
            }
        }

        async function runTests() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Running Tests...';
            
            // Reset results
            testResults = { passed: 0, failed: 0, tests: [] };
            document.getElementById('results').innerHTML = '';
            
            console.log('üß™ Starting user_loyalty_cards Table Fix Tests');
            
            // Run all tests
            await testDatabaseConnection();
            await testTableStructure();
            await testLoyaltyNumberGeneration();
            await testSchemaCompatibility();
            await testRLSPolicies();
            
            // Update summary
            updateSummary();
            
            // Re-enable button
            testBtn.disabled = false;
            testBtn.textContent = 'Run Tests';
            
            console.log('üìä Test Results:', testResults);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').innerHTML = '';
            testResults = { passed: 0, failed: 0, tests: [] };
        }

        // Load Supabase client
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2';
        script.onload = () => {
            console.log('Supabase client loaded');
            updateSummary();
        };
        document.head.appendChild(script);
    </script>
</body>
</html>
