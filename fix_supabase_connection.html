<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Supabase Connection Fix</h1>
        <p>This tool will help fix the Supabase connection issues and force the application to use the real Supabase client instead of the mock client.</p>
        
        <div id="status" class="status info">
            Ready to test and fix Supabase connection...
        </div>
        
        <div>
            <button onclick="testConnection()">Test Current Connection</button>
            <button onclick="forceRealSupabase()">Force Real Supabase</button>
            <button onclick="clearMockData()">Clear Mock Data</button>
            <button onclick="refreshPage()">Refresh Application</button>
        </div>
        
        <div id="log" class="log"></div>
        
        <h3>Diagnostic Information</h3>
        <div id="diagnostics"></div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        let diagnosticsElement = document.getElementById('diagnostics');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function setStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        function updateDiagnostics() {
            const diagnostics = {
                'Current URL': window.location.href,
                'User Agent': navigator.userAgent,
                'Local Storage Keys': Object.keys(localStorage),
                'Mock User Data': localStorage.getItem('mock_oauth_user') ? 'Present' : 'Not Present',
                'Environment Variables': {
                    'VITE_SUPABASE_URL': window.location.href.includes('localhost') ? 'Local Development' : 'Production',
                    'VITE_SUPABASE_ANON_KEY': 'Present' // Assume present if app is running
                }
            };
            
            diagnosticsElement.innerHTML = '<pre>' + JSON.stringify(diagnostics, null, 2) + '</pre>';
        }
        
        async function testConnection() {
            setStatus('Testing current connection...', 'info');
            log('ðŸ” Testing current Supabase connection...');
            
            try {
                // Check if we can access the database adapter
                if (typeof window.databaseAdapter !== 'undefined') {
                    log('âœ… Database adapter found');
                    
                    // Test if it's in mock mode
                    const isMock = window.databaseAdapter.isMockMode ? window.databaseAdapter.isMockMode() : false;
                    log(`ðŸ“Š Mock mode status: ${isMock ? 'ACTIVE (PROBLEM)' : 'INACTIVE (GOOD)'}`);
                    
                    if (isMock) {
                        setStatus('âŒ Currently using MOCK client - this is the problem!', 'error');
                        log('âŒ PROBLEM IDENTIFIED: Application is using mock client');
                        log('ðŸ’¡ SOLUTION: Use "Force Real Supabase" button to fix this');
                    } else {
                        setStatus('âœ… Using real Supabase client', 'success');
                        log('âœ… GOOD: Application is using real Supabase client');
                    }
                } else {
                    log('âŒ Database adapter not found in window object');
                    setStatus('âŒ Database adapter not accessible', 'error');
                }
                
                // Test direct Supabase connection
                log('ðŸ” Testing direct Supabase connection...');
                const response = await fetch('https://wndswqvqogeblksrujpg.supabase.co/rest/v1/profiles?select=count&limit=1', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZHN3cXZxb2dlYmxrc3J1anBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzMTA5NzQsImV4cCI6MjA1MDg4Njk3NH0.8Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZHN3cXZxb2dlYmxrc3J1anBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzMTA5NzQsImV4cCI6MjA1MDg4Njk3NH0.8Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q5Q'
                    }
                });
                
                if (response.ok) {
                    log('âœ… Direct Supabase API connection successful');
                    setStatus('âœ… Supabase service is working - connection issue is in the app', 'success');
                } else {
                    log(`âŒ Direct Supabase API connection failed: ${response.status} ${response.statusText}`);
                    setStatus('âŒ Supabase service issue detected', 'error');
                }
                
            } catch (error) {
                log(`âŒ Connection test failed: ${error.message}`);
                setStatus('âŒ Connection test failed', 'error');
            }
            
            updateDiagnostics();
        }
        
        async function forceRealSupabase() {
            setStatus('Forcing real Supabase client...', 'info');
            log('ðŸ”„ Forcing real Supabase client...');
            
            try {
                // Clear any mock data
                localStorage.removeItem('mock_oauth_user');
                log('ðŸ§¹ Cleared mock user data from localStorage');
                
                // Try to access the database adapter and force real client
                if (typeof window.databaseAdapter !== 'undefined') {
                    if (window.databaseAdapter.forceRealSupabase) {
                        const success = window.databaseAdapter.forceRealSupabase();
                        if (success) {
                            log('âœ… Successfully forced real Supabase client');
                            setStatus('âœ… Real Supabase client forced successfully!', 'success');
                        } else {
                            log('âŒ Failed to force real Supabase client');
                            setStatus('âŒ Failed to force real Supabase client', 'error');
                        }
                    } else {
                        log('âš ï¸ forceRealSupabase method not available');
                        setStatus('âš ï¸ Force method not available', 'warning');
                    }
                } else {
                    log('âŒ Database adapter not found');
                    setStatus('âŒ Database adapter not accessible', 'error');
                }
                
                // Test the connection after forcing
                log('ðŸ” Testing connection after forcing real client...');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait a bit
                
                if (typeof window.databaseAdapter !== 'undefined' && window.databaseAdapter.isMockMode) {
                    const isMock = window.databaseAdapter.isMockMode();
                    if (!isMock) {
                        log('âœ… SUCCESS: Now using real Supabase client');
                        setStatus('âœ… SUCCESS: Now using real Supabase client!', 'success');
                    } else {
                        log('âŒ Still using mock client after force attempt');
                        setStatus('âŒ Still using mock client - may need page refresh', 'warning');
                    }
                }
                
            } catch (error) {
                log(`âŒ Force real Supabase failed: ${error.message}`);
                setStatus('âŒ Force operation failed', 'error');
            }
            
            updateDiagnostics();
        }
        
        function clearMockData() {
            setStatus('Clearing mock data...', 'info');
            log('ðŸ§¹ Clearing all mock data...');
            
            // Clear localStorage items that might be causing mock mode
            const keysToRemove = [
                'mock_oauth_user',
                'mock_auth_session',
                'mock_user_data',
                'supabase_mock_mode'
            ];
            
            keysToRemove.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    log(`âœ… Removed ${key} from localStorage`);
                }
            });
            
            // Clear any session storage
            sessionStorage.clear();
            log('âœ… Cleared session storage');
            
            setStatus('âœ… Mock data cleared successfully!', 'success');
            log('ðŸ’¡ Now try signing in again - it should use real Supabase');
            
            updateDiagnostics();
        }
        
        function refreshPage() {
            setStatus('Refreshing application...', 'info');
            log('ðŸ”„ Refreshing application...');
            
            // Clear any cached data
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Force a hard refresh
            window.location.reload(true);
        }
        
        // Initialize diagnostics on page load
        updateDiagnostics();
        
        // Auto-test connection on page load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>

