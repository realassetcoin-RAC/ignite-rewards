<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Plan Schema Fix Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            text-align: center;
            margin-bottom: 30px;
        }
        .error-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .solution-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .step {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            color: #ea580c;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        textarea {
            height: 200px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Shop Plan Schema Fix Tool</h1>
        
        <div class="error-box">
            <h3>‚ùå Error: "Failed to save plan: the schema must be one of the following:api"</h3>
            <p>This error occurs when there's a mismatch between the database schema configuration and what the application expects. The merchant_subscription_plans table may be in the wrong schema or have incorrect permissions.</p>
        </div>

        <div class="solution-box">
            <h3>‚úÖ Solution</h3>
            <p>This tool will fix the schema configuration by ensuring the merchant_subscription_plans table exists in the public schema with proper permissions and RLS policies.</p>
        </div>

        <div class="step">
            <h3>Step 1: Diagnostic Check</h3>
            <p>First, let's check the current state of your database. Copy and paste this SQL into your Supabase SQL Editor:</p>
            <div class="code-block" id="diagnostic-sql">
-- Check if merchant_subscription_plans table exists in public schema
SELECT 
  'merchant_subscription_plans in public schema' as check_name,
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.tables 
      WHERE table_schema = 'public' AND table_name = 'merchant_subscription_plans'
    ) THEN 'EXISTS'
    ELSE 'DOES NOT EXIST'
  END as result;

-- Check RLS status
SELECT 
  'RLS enabled on merchant_subscription_plans' as check_name,
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM pg_tables 
      WHERE schemaname = 'public' AND tablename = 'merchant_subscription_plans' AND rowsecurity = true
    ) THEN 'ENABLED'
    WHEN EXISTS (
      SELECT 1 FROM pg_tables 
      WHERE schemaname = 'public' AND tablename = 'merchant_subscription_plans' AND rowsecurity = false
    ) THEN 'DISABLED'
    ELSE 'TABLE DOES NOT EXIST'
  END as result;

-- Check if we can query the table
DO $$
DECLARE
  plan_count integer;
BEGIN
  BEGIN
    SELECT COUNT(*) INTO plan_count FROM public.merchant_subscription_plans;
    RAISE NOTICE '‚úÖ Can query merchant_subscription_plans: % plans found', plan_count;
  EXCEPTION WHEN OTHERS THEN
    RAISE NOTICE '‚ùå Cannot query merchant_subscription_plans: %', SQLERRM;
  END;
END $$;
            </div>
            <button class="button" onclick="copyToClipboard('diagnostic-sql')">Copy Diagnostic SQL</button>
        </div>

        <div class="step">
            <h3>Step 2: Apply the Fix</h3>
            <p>Copy and paste this SQL into your Supabase SQL Editor to fix the schema issue:</p>
            <div class="code-block" id="fix-sql">
-- Fix for "Failed to save plan: the schema must be one of the following:api" error
-- This ensures the merchant_subscription_plans table exists in the public schema with proper permissions

-- Drop and recreate the merchant_subscription_plans table to ensure it's in the public schema
DROP TABLE IF EXISTS public.merchant_subscription_plans CASCADE;

-- Create the merchant_subscription_plans table in the public schema
CREATE TABLE public.merchant_subscription_plans (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  price_monthly DECIMAL(10, 2) NOT NULL DEFAULT 0,
  features JSONB DEFAULT '[]'::jsonb,
  trial_days INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Enable RLS on the table
ALTER TABLE public.merchant_subscription_plans ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to avoid conflicts
DROP POLICY IF EXISTS "Anyone can view active plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can manage plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can view all subscription plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can insert plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can update plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can delete plans" ON public.merchant_subscription_plans;

-- Create comprehensive RLS policies
CREATE POLICY "Anyone can view active plans" 
ON public.merchant_subscription_plans 
FOR SELECT 
TO authenticated
USING (is_active = true);

CREATE POLICY "Admins can view all plans" 
ON public.merchant_subscription_plans 
FOR SELECT 
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE profiles.id = auth.uid()
    AND profiles.role = 'admin'
  )
);

CREATE POLICY "Admins can insert plans" 
ON public.merchant_subscription_plans 
FOR INSERT 
TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE profiles.id = auth.uid()
    AND profiles.role = 'admin'
  )
);

CREATE POLICY "Admins can update plans" 
ON public.merchant_subscription_plans 
FOR UPDATE 
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE profiles.id = auth.uid()
    AND profiles.role = 'admin'
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE profiles.id = auth.uid()
    AND profiles.role = 'admin'
  )
);

CREATE POLICY "Admins can delete plans" 
ON public.merchant_subscription_plans 
FOR DELETE 
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE profiles.id = auth.uid()
    AND profiles.role = 'admin'
  )
);

-- Grant necessary permissions
GRANT USAGE ON SCHEMA public TO authenticated, anon;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.merchant_subscription_plans TO authenticated;
GRANT SELECT ON public.merchant_subscription_plans TO anon;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO authenticated;

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_merchant_subscription_plans_active ON public.merchant_subscription_plans(is_active);
CREATE INDEX IF NOT EXISTS idx_merchant_subscription_plans_name ON public.merchant_subscription_plans(name);

-- Create the update trigger
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_merchant_subscription_plans_updated_at
  BEFORE UPDATE ON public.merchant_subscription_plans
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

-- Insert default subscription plans
INSERT INTO public.merchant_subscription_plans (name, description, price_monthly, features, trial_days, is_active) VALUES
('Basic', 'Essential features for small businesses', 29.99, '["Basic analytics", "Customer loyalty tracking", "Email support"]', 30, true),
('Premium', 'Advanced features for growing businesses', 79.99, '["Advanced analytics", "Custom branding", "Priority support", "API access"]', 30, true),
('Enterprise', 'Full-featured solution for large businesses', 199.99, '["All Premium features", "Dedicated account manager", "Custom integrations", "24/7 phone support"]', 30, true)
ON CONFLICT (name) DO NOTHING;

-- Ensure the profiles table exists in public schema for admin checks
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  email VARCHAR(255),
  full_name VARCHAR(255),
  avatar_url TEXT,
  role VARCHAR(50) DEFAULT 'user',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Enable RLS on profiles
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Create policies for profiles
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Admins can view all profiles" ON public.profiles;

CREATE POLICY "Users can view their own profile" 
ON public.profiles 
FOR SELECT 
TO authenticated
USING (auth.uid() = id);

CREATE POLICY "Admins can view all profiles" 
ON public.profiles 
FOR SELECT 
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profiles p
    WHERE p.id = auth.uid()
    AND p.role = 'admin'
  )
);

-- Grant permissions on profiles
GRANT SELECT, INSERT, UPDATE, DELETE ON public.profiles TO authenticated;
GRANT SELECT ON public.profiles TO anon;

-- Create index on profiles role for admin checks
CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role);

-- Verify the fix
DO $$
DECLARE
  table_exists boolean;
  policies_count integer;
BEGIN
  -- Check if table exists
  SELECT EXISTS (
    SELECT 1 FROM information_schema.tables 
    WHERE table_schema = 'public' AND table_name = 'merchant_subscription_plans'
  ) INTO table_exists;
  
  IF table_exists THEN
    RAISE NOTICE '‚úÖ merchant_subscription_plans table exists in public schema';
  ELSE
    RAISE NOTICE '‚ùå merchant_subscription_plans table does not exist in public schema';
  END IF;
  
  -- Check policies
  SELECT COUNT(*) INTO policies_count
  FROM pg_policies 
  WHERE schemaname = 'public' AND tablename = 'merchant_subscription_plans';
  
  RAISE NOTICE '‚úÖ Found % RLS policies on merchant_subscription_plans', policies_count;
  
  -- Check if we can query the table
  PERFORM COUNT(*) FROM public.merchant_subscription_plans;
  RAISE NOTICE '‚úÖ Can successfully query merchant_subscription_plans table';
  
EXCEPTION WHEN OTHERS THEN
  RAISE NOTICE '‚ùå Error querying merchant_subscription_plans: %', SQLERRM;
END $$;
            </div>
            <button class="button" onclick="copyToClipboard('fix-sql')">Copy Fix SQL</button>
        </div>

        <div class="step">
            <h3>Step 3: Verify the Fix</h3>
            <p>After running the fix SQL, run this verification query:</p>
            <div class="code-block" id="verify-sql">
-- Verify the fix worked
SELECT 
  'merchant_subscription_plans table' as check_name,
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.tables 
      WHERE table_schema = 'public' AND table_name = 'merchant_subscription_plans'
    ) THEN '‚úÖ EXISTS'
    ELSE '‚ùå MISSING'
  END as result

UNION ALL

SELECT 
  'RLS policies count' as check_name,
  COALESCE(
    (SELECT COUNT(*)::text FROM pg_policies WHERE schemaname = 'public' AND tablename = 'merchant_subscription_plans'),
    '0'
  ) as result

UNION ALL

SELECT 
  'Default plans count' as check_name,
  (SELECT COUNT(*)::text FROM public.merchant_subscription_plans) as result;
            </div>
            <button class="button" onclick="copyToClipboard('verify-sql')">Copy Verification SQL</button>
        </div>

        <div class="success">
            <h3>‚úÖ What This Fix Does</h3>
            <ul>
                <li>Recreates the merchant_subscription_plans table in the public schema</li>
                <li>Sets up proper RLS policies for admin access</li>
                <li>Grants necessary permissions to authenticated users</li>
                <li>Creates indexes for better performance</li>
                <li>Inserts default subscription plans</li>
                <li>Ensures the profiles table exists for admin role checks</li>
            </ul>
        </div>

        <div class="warning">
            <h3>‚ö†Ô∏è Important Notes</h3>
            <ul>
                <li>This will recreate the merchant_subscription_plans table, so any existing plans will be lost</li>
                <li>Make sure your user has 'admin' role in the profiles table</li>
                <li>After applying the fix, refresh your application and try creating a plan again</li>
            </ul>
        </div>

        <div class="step">
            <h3>Step 4: Test the Fix</h3>
            <p>After applying the fix:</p>
            <ol>
                <li>Refresh your application</li>
                <li>Go to the shop tab</li>
                <li>Try creating a new plan</li>
                <li>The error should be resolved</li>
            </ol>
        </div>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                // Show success message
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.style.background = '#10b981';
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.style.background = '#3b82f6';
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy to clipboard. Please select and copy manually.');
            });
        }
    </script>
</body>
</html>