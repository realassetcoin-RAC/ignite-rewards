<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Bypass Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background-color: #3367d6; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .auth-link {
            display: block;
            background-color: #4285f4;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .auth-link:hover {
            background-color: #3367d6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ OAuth Bypass Test</h1>
        
        <div id="status" class="status warning">
            <strong>Status:</strong> Origin issue detected - using bypass methods
        </div>

        <div class="test-section">
            <h3>üîß Current Issue</h3>
            <p><strong>Problem:</strong> Google is rejecting <code>http://localhost:8084</code> as an authorized origin.</p>
            <p><strong>Error:</strong> <code>[GSI_LOGGER]: The given origin is not allowed for the given client ID</code></p>
            <p><strong>Solution:</strong> We'll bypass the One Tap method and use direct redirect OAuth.</p>
        </div>

        <div class="test-section">
            <h3>üéØ Bypass Methods</h3>
            
            <h4>Method 1: Direct Redirect OAuth</h4>
            <p>This bypasses the One Tap origin check entirely by using the redirect flow.</p>
            <a href="#" id="redirect-oauth-link" class="auth-link">
                üîó Test Google OAuth Redirect
            </a>
            
            <h4>Method 2: Mock Authentication</h4>
            <p>This creates a mock authenticated session for testing purposes.</p>
            <button onclick="createMockAuth()">üé≠ Create Mock Authentication</button>
            
            <h4>Method 3: Check Current Auth State</h4>
            <p>Check if there's already an active session.</p>
            <button onclick="checkCurrentAuth()">üîç Check Current Auth</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div class="log" id="log">
                <div>Test log will appear here...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Current Auth State</h3>
            <div id="auth-state">
                <p><strong>Session:</strong> <span id="session-status">Not checked</span></p>
                <p><strong>User:</strong> <span id="user-status">Not checked</span></p>
                <p><strong>Google User:</strong> <span id="google-user-status">Not checked</span></p>
                <p><strong>Google Token:</strong> <span id="google-token-status">Not checked</span></p>
            </div>
        </div>

        <div class="test-section">
            <h3>üîß Google Cloud Console Fix</h3>
            <p><strong>If you haven't tried this yet:</strong></p>
            <ol>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console ‚Üí Credentials</a></li>
                <li>Find your OAuth client: <code>965254391266-pi0nuo882g88tjn1hgn9uh7n72macekh.apps.googleusercontent.com</code></li>
                <li>In <strong>Authorized JavaScript origins</strong>:
                    <ul>
                        <li>DELETE <code>http://localhost:8084</code></li>
                        <li>SAVE</li>
                        <li>Wait 30 seconds</li>
                        <li>ADD <code>http://localhost:8084</code> again</li>
                        <li>SAVE</li>
                    </ul>
                </li>
                <li>Wait 5-10 minutes for propagation</li>
            </ol>
        </div>
    </div>

    <script>
        const CLIENT_ID = '965254391266-pi0nuo882g88tjn1hgn9uh7n72macekh.apps.googleusercontent.com';
        const REDIRECT_URI = window.location.origin + '/auth/callback';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? '#721c24' : type === 'success' ? '#155724' : type === 'warning' ? '#856404' : '#0c5460';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateAuthState() {
            try {
                const authSession = localStorage.getItem('auth_session');
                const authUser = localStorage.getItem('auth_user');
                const googleUser = localStorage.getItem('google_user');
                const googleToken = localStorage.getItem('google_access_token');

                document.getElementById('session-status').textContent = authSession ? '‚úÖ Active' : '‚ùå None';
                document.getElementById('user-status').textContent = authUser ? '‚úÖ Active' : '‚ùå None';
                document.getElementById('google-user-status').textContent = googleUser ? '‚úÖ Active' : '‚ùå None';
                document.getElementById('google-token-status').textContent = googleToken ? '‚úÖ Active' : '‚ùå None';

                if (authSession && authUser) {
                    const sessionData = JSON.parse(authSession);
                    const userData = JSON.parse(authUser);
                    log(`üìß User Email: ${userData.email}`, 'success');
                    log(`‚è∞ Session Expires: ${new Date(sessionData.expires_at).toLocaleString()}`, 'success');
                    updateStatus('‚úÖ User is authenticated!', 'success');
                } else {
                    updateStatus('‚ùå No active session found', 'error');
                }
            } catch (error) {
                log(`‚ùå Error checking auth state: ${error.message}`, 'error');
            }
        }

        function createMockAuth() {
            log('üé≠ Creating mock authentication...');
            updateStatus('Creating mock auth...', 'info');

            try {
                const mockUser = {
                    id: 'mock_user_' + Date.now(),
                    email: 'test@example.com',
                    name: 'Test User',
                    picture: 'https://via.placeholder.com/150',
                    verified_email: true
                };

                const session = {
                    user: {
                        id: mockUser.id,
                        email: mockUser.email,
                        user_metadata: {
                            full_name: mockUser.name,
                            avatar_url: mockUser.picture,
                            email_verified: mockUser.verified_email
                        },
                        email_confirmed_at: mockUser.verified_email ? new Date().toISOString() : null
                    },
                    access_token: 'mock_token_' + Date.now(),
                    expires_at: Date.now() + (3600 * 1000) // 1 hour
                };

                localStorage.setItem('google_user', JSON.stringify(mockUser));
                localStorage.setItem('google_access_token', session.access_token);
                localStorage.setItem('auth_session', JSON.stringify(session));
                localStorage.setItem('auth_user', JSON.stringify(session.user));

                window.dispatchEvent(new Event('storage'));
                window.dispatchEvent(new CustomEvent('auth-state-change', {
                    detail: { event: 'SIGNED_IN', session }
                }));

                log('‚úÖ Mock authentication created successfully', 'success');
                updateStatus('‚úÖ Mock authentication successful!', 'success');
                updateAuthState();

            } catch (error) {
                log(`‚ùå Error creating mock auth: ${error.message}`, 'error');
                updateStatus('Mock auth failed', 'error');
            }
        }

        function checkCurrentAuth() {
            log('üîç Checking current authentication state...');
            updateAuthState();
        }

        function setupRedirectOAuth() {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `response_type=code&` +
                `scope=openid%20email%20profile&` +
                `access_type=offline&` +
                `prompt=select_account&` +
                `include_granted_scopes=true&` +
                `state=${encodeURIComponent(JSON.stringify({ method: 'redirect', timestamp: Date.now() }))}`;

            const link = document.getElementById('redirect-oauth-link');
            link.href = authUrl;
            link.onclick = function() {
                log('üîÑ Redirecting to Google OAuth...');
                log(`üîó Redirect URL: ${authUrl}`, 'info');
                updateStatus('Redirecting to Google OAuth...', 'info');
                return true; // Allow the redirect
            };

            log('üîó Redirect OAuth link configured', 'success');
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('üöÄ OAuth Bypass Test page loaded');
            log('‚ö†Ô∏è Origin issue detected - using bypass methods', 'warning');
            setupRedirectOAuth();
            checkCurrentAuth();
        });

        // Listen for auth state changes
        window.addEventListener('auth-state-change', (event) => {
            log('üì° Auth state change event received', 'info');
            updateAuthState();
        });

        // Listen for storage changes (from other tabs)
        window.addEventListener('storage', (event) => {
            if (event.key === 'auth_session' || event.key === 'auth_user') {
                log('üì° Storage change detected', 'info');
                updateAuthState();
            }
        });
    </script>
</body>
</html>

