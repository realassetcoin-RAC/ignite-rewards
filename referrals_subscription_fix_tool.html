<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referrals & Subscription Plans Database Fix Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .error-box {
            background: #fee;
            border: 1px solid #fcc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .error-box h3 {
            color: #c00;
            margin-bottom: 10px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .sql-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            position: relative;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .copy-button:hover {
            background: #1d4ed8;
        }
        
        .copy-button.copied {
            background: #059669;
        }
        
        .instructions {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .status-check {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .success-message {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            padding: 15px;
            border-radius: 5px;
            color: #065f46;
        }
        
        .code-inline {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .button:hover {
            background: #1d4ed8;
        }
        
        .button.secondary {
            background: #6b7280;
        }
        
        .button.secondary:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
            Referrals & Subscription Plans Fix Tool
        </h1>
        <p class="subtitle">Fix database schema configuration errors for referrals and subscription plans</p>
        
        <div class="error-box">
            <h3>🚨 Current Errors:</h3>
            <ul>
                <li><strong>Referrals:</strong> "Database schema configuration error. The referrals feature may not be properly setup."</li>
                <li><strong>Subscription Plans:</strong> "Database schema configuration error. The subscription plans feature may not be properly setup."</li>
            </ul>
        </div>
        
        <div class="section">
            <h2>📋 Quick Fix Instructions</h2>
            <div class="instructions">
                <ol>
                    <li>Log in to your <a href="https://app.supabase.com" target="_blank">Supabase Dashboard</a></li>
                    <li>Navigate to the <strong>SQL Editor</strong> section</li>
                    <li>Click <strong>"New query"</strong></li>
                    <li>Copy the SQL fix below (click the Copy button)</li>
                    <li>Paste it into the SQL Editor</li>
                    <li>Click <strong>"Run"</strong> to execute the fix</li>
                    <li>Check for success messages in the output</li>
                </ol>
            </div>
        </div>
        
        <div class="section">
            <h2>🔧 Database Fix SQL</h2>
            <div class="sql-box">
                <button class="copy-button" onclick="copySQL()">Copy SQL</button>
                <pre id="sqlContent">-- Fix Database Schema Configuration for Referrals and Subscription Plans
-- This comprehensive migration ensures all tables, permissions, and RLS policies are properly configured

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create the update_updated_at_column function if it doesn't exist
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create the check_admin_access function if it doesn't exist
CREATE OR REPLACE FUNCTION public.check_admin_access()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles 
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create referral_campaigns table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.referral_campaigns (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  reward_points INTEGER NOT NULL DEFAULT 10,
  start_date TIMESTAMP WITH TIME ZONE NOT NULL,
  end_date TIMESTAMP WITH TIME ZONE NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Create user_referrals table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.user_referrals (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  referrer_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  referral_code TEXT NOT NULL UNIQUE,
  referred_email TEXT,
  referred_user_id UUID REFERENCES auth.users(id),
  merchant_id UUID,
  campaign_id UUID REFERENCES public.referral_campaigns(id),
  status TEXT DEFAULT 'pending',
  reward_points INTEGER DEFAULT 0,
  completed_at TIMESTAMP WITH TIME ZONE,
  rewarded_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Create merchant_subscription_plans table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.merchant_subscription_plans (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  price_monthly DECIMAL(10,2) NOT NULL,
  features JSONB DEFAULT '[]',
  trial_days INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Enable RLS on all tables
ALTER TABLE public.referral_campaigns ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_referrals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.merchant_subscription_plans ENABLE ROW LEVEL SECURITY;

-- Drop all existing policies to avoid conflicts
DROP POLICY IF EXISTS "Anyone can view active campaigns" ON public.referral_campaigns;
DROP POLICY IF EXISTS "Admins can manage campaigns" ON public.referral_campaigns;
DROP POLICY IF EXISTS "Users can view their own referrals" ON public.user_referrals;
DROP POLICY IF EXISTS "Users can create their own referrals" ON public.user_referrals;
DROP POLICY IF EXISTS "Users can update their own referrals" ON public.user_referrals;
DROP POLICY IF EXISTS "Admins can delete referrals" ON public.user_referrals;
DROP POLICY IF EXISTS "Anyone can view active plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can insert plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can update plans" ON public.merchant_subscription_plans;
DROP POLICY IF EXISTS "Admins can delete plans" ON public.merchant_subscription_plans;

-- Create RLS policies
CREATE POLICY "Anyone can view active campaigns" ON public.referral_campaigns 
FOR SELECT TO authenticated USING (is_active = true OR public.check_admin_access());

CREATE POLICY "Admins can manage campaigns" ON public.referral_campaigns 
FOR ALL TO authenticated USING (public.check_admin_access()) WITH CHECK (public.check_admin_access());

CREATE POLICY "Users can view their own referrals" ON public.user_referrals 
FOR SELECT TO authenticated USING (auth.uid() = referrer_id OR auth.uid() = referred_user_id OR public.check_admin_access());

CREATE POLICY "Users can create their own referrals" ON public.user_referrals 
FOR INSERT TO authenticated WITH CHECK (auth.uid() = referrer_id OR public.check_admin_access());

CREATE POLICY "Users can update their own referrals" ON public.user_referrals 
FOR UPDATE TO authenticated USING (auth.uid() = referrer_id OR public.check_admin_access()) 
WITH CHECK (auth.uid() = referrer_id OR public.check_admin_access());

CREATE POLICY "Admins can delete referrals" ON public.user_referrals 
FOR DELETE TO authenticated USING (public.check_admin_access());

CREATE POLICY "Anyone can view active plans" ON public.merchant_subscription_plans 
FOR SELECT TO authenticated USING (is_active = true OR public.check_admin_access());

CREATE POLICY "Admins can insert plans" ON public.merchant_subscription_plans 
FOR INSERT TO authenticated WITH CHECK (public.check_admin_access());

CREATE POLICY "Admins can update plans" ON public.merchant_subscription_plans 
FOR UPDATE TO authenticated USING (public.check_admin_access()) WITH CHECK (public.check_admin_access());

CREATE POLICY "Admins can delete plans" ON public.merchant_subscription_plans 
FOR DELETE TO authenticated USING (public.check_admin_access());

-- Grant permissions
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.referral_campaigns TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.user_referrals TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.merchant_subscription_plans TO authenticated;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO authenticated;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_user_referrals_referrer ON public.user_referrals(referrer_id);
CREATE INDEX IF NOT EXISTS idx_user_referrals_code ON public.user_referrals(referral_code);
CREATE INDEX IF NOT EXISTS idx_merchant_subscription_plans_active ON public.merchant_subscription_plans(is_active);
CREATE INDEX IF NOT EXISTS idx_referral_campaigns_active ON public.referral_campaigns(is_active);

-- Insert default data if tables are empty
INSERT INTO public.merchant_subscription_plans (name, description, price_monthly, features, trial_days) 
SELECT 'Basic', 'Essential features for small businesses', 29.99, '["Basic analytics", "Customer loyalty tracking", "Email support"]', 30
WHERE NOT EXISTS (SELECT 1 FROM public.merchant_subscription_plans WHERE name = 'Basic');

INSERT INTO public.merchant_subscription_plans (name, description, price_monthly, features, trial_days) 
SELECT 'Premium', 'Advanced features for growing businesses', 79.99, '["Advanced analytics", "Custom branding", "Priority support", "API access"]', 30
WHERE NOT EXISTS (SELECT 1 FROM public.merchant_subscription_plans WHERE name = 'Premium');

INSERT INTO public.merchant_subscription_plans (name, description, price_monthly, features, trial_days) 
SELECT 'Enterprise', 'Full-featured solution for large businesses', 199.99, '["All Premium features", "Dedicated account manager", "Custom integrations", "24/7 support"]', 30
WHERE NOT EXISTS (SELECT 1 FROM public.merchant_subscription_plans WHERE name = 'Enterprise');

INSERT INTO public.referral_campaigns (name, description, reward_points, start_date, end_date) 
SELECT 'Launch Campaign', 'Earn 10 points for each merchant referral', 10, now(), now() + interval '1 year'
WHERE NOT EXISTS (SELECT 1 FROM public.referral_campaigns WHERE name = 'Launch Campaign');

-- Verify the fix
DO $$
DECLARE
  tables_ok BOOLEAN := true;
  table_count INTEGER;
BEGIN
  -- Check tables exist
  SELECT COUNT(*) INTO table_count FROM pg_tables 
  WHERE schemaname = 'public' AND tablename IN ('user_referrals', 'merchant_subscription_plans', 'referral_campaigns');
  
  IF table_count = 3 THEN
    RAISE NOTICE '✅ All required tables exist';
  ELSE
    RAISE WARNING '❌ Some tables are missing';
    tables_ok := false;
  END IF;
  
  -- Check RLS is enabled
  SELECT COUNT(*) INTO table_count FROM pg_tables 
  WHERE schemaname = 'public' AND rowsecurity = true
  AND tablename IN ('user_referrals', 'merchant_subscription_plans', 'referral_campaigns');
  
  IF table_count = 3 THEN
    RAISE NOTICE '✅ RLS is enabled on all tables';
  ELSE
    RAISE WARNING '❌ RLS is not enabled on all tables';
    tables_ok := false;
  END IF;
  
  IF tables_ok THEN
    RAISE NOTICE '🎉 Database fix completed successfully!';
  ELSE
    RAISE WARNING '⚠️ Some issues remain - please check the warnings above';
  END IF;
END $$;</pre>
            </div>
        </div>
        
        <div class="section">
            <h2>✅ After Running the Fix</h2>
            <div class="status-check">
                <h3>Verification Steps:</h3>
                <ol>
                    <li>In Supabase SQL Editor, run this check:
                        <div class="code-inline">SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND tablename IN ('user_referrals', 'merchant_subscription_plans', 'referral_campaigns');</div>
                    </li>
                    <li>You should see all three tables with <code>rowsecurity = true</code></li>
                    <li>Go back to your application and refresh the page</li>
                    <li>Try accessing the Referral Manager and Subscription Plan Manager</li>
                </ol>
            </div>
            
            <div class="success-message">
                <strong>🎉 Expected Result:</strong> Both features should load without configuration errors!
            </div>
        </div>
        
        <div class="section">
            <h2>🔍 Troubleshooting</h2>
            <div class="warning">
                <strong>Still seeing errors?</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Clear your browser cache (Ctrl+Shift+R or Cmd+Shift+R)</li>
                    <li>Log out and log back in to refresh permissions</li>
                    <li>Check browser console (F12) for any JavaScript errors</li>
                    <li>Ensure your user account has admin role in the profiles table</li>
                </ul>
            </div>
        </div>
        
        <div class="button-group">
            <a href="https://app.supabase.com" target="_blank" class="button">Open Supabase Dashboard</a>
            <button class="button secondary" onclick="downloadSQL()">Download SQL File</button>
        </div>
    </div>
    
    <script>
        function copySQL() {
            const sqlContent = document.getElementById('sqlContent').textContent;
            navigator.clipboard.writeText(sqlContent).then(() => {
                const button = document.querySelector('.copy-button');
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copy SQL';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }
        
        function downloadSQL() {
            const sqlContent = document.getElementById('sqlContent').textContent;
            const blob = new Blob([sqlContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fix_referrals_subscription_configuration.sql';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>
</body>
</html>