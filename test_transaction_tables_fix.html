<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Tables Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .pass {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .fail {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Transaction Tables Fix Test</h1>
        <p>This test will verify that the loyalty_transactions and transaction_qr_codes table fixes are working correctly.</p>
        
        <div>
            <button onclick="runTests()" id="testBtn">Run Tests</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div id="results"></div>
        <div id="summary"></div>
    </div>

    <script>
        // Test configuration - Update these with your actual Supabase credentials
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Replace with your actual URL
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your actual anon key
        
        // Instructions:
        // 1. Replace 'YOUR_SUPABASE_URL' with your actual Supabase URL
        // 2. Replace 'YOUR_SUPABASE_ANON_KEY' with your actual anon key
        // 3. Save this file and open it in your browser
        // 4. Click "Run Tests" to verify the fix worked
        
        let testResults = {
            passed: 0,
            failed: 0,
            tests: []
        };

        function addResult(testName, passed, message = '') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            
            const status = passed ? '‚úÖ PASS' : '‚ùå FAIL';
            resultDiv.innerHTML = `<strong>${status}: ${testName}</strong>${message ? `<br>${message}` : ''}`;
            
            resultsDiv.appendChild(resultDiv);
            
            testResults.tests.push({ name: testName, passed, message });
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const total = testResults.passed + testResults.failed;
            const successRate = total > 0 ? ((testResults.passed / total) * 100).toFixed(1) : 0;
            
            let summaryClass = 'warning';
            let summaryText = '';
            
            if (testResults.failed === 0 && testResults.passed > 0) {
                summaryClass = 'success';
                summaryText = `
                    <h3>üéâ ALL TESTS PASSED!</h3>
                    <p>The transaction tables fix is working correctly.</p>
                    <p><strong>Success Rate:</strong> ${successRate}% (${testResults.passed}/${total})</p>
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>‚úÖ Database fix is working correctly</li>
                        <li>‚úÖ Both loyalty_transactions and transaction_qr_codes are healthy</li>
                        <li>‚úÖ Admin health tab should show green status</li>
                    </ul>
                `;
            } else if (testResults.failed > 0) {
                summaryClass = 'error';
                summaryText = `
                    <h3>‚ö†Ô∏è Some Tests Failed</h3>
                    <p><strong>Success Rate:</strong> ${successRate}% (${testResults.passed}/${total})</p>
                    <p><strong>Failed Tests:</strong></p>
                    <ul>
                        ${testResults.tests.filter(test => !test.passed).map(test => `<li>${test.name}: ${test.message}</li>`).join('')}
                    </ul>
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>1. Apply the database migration: fix_loyalty_transactions_and_qr_codes.sql</li>
                        <li>2. Re-run this test to verify the fix</li>
                        <li>3. Check Supabase dashboard for any permission issues</li>
                    </ul>
                `;
            } else {
                summaryText = `
                    <h3>‚ÑπÔ∏è No Tests Run Yet</h3>
                    <p>Click "Run Tests" to start testing the transaction tables fix.</p>
                `;
            }
            
            summaryDiv.className = `summary ${summaryClass}`;
            summaryDiv.innerHTML = summaryText;
        }

        async function testDatabaseConnection() {
            try {
                if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    addResult('Database Connection', false, 'Please update SUPABASE_URL and SUPABASE_ANON_KEY in the script');
                    return false;
                }

                // Create Supabase client
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient.from('loyalty_transactions').select('count').limit(1);
                addResult('Database Connection', !error, error ? error.message : 'Connected successfully');
                return !error;
            } catch (err) {
                addResult('Database Connection', false, err.message);
                return false;
            }
        }

        async function testLoyaltyTransactionsTable() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient
                    .from('loyalty_transactions')
                    .select('id, user_id, merchant_id, loyalty_number, transaction_amount, points_earned, transaction_reference, transaction_date, created_at')
                    .limit(1);
                
                addResult('Loyalty Transactions Table Structure', !error, error ? error.message : 'All expected columns present');
                return !error;
            } catch (err) {
                addResult('Loyalty Transactions Table Structure', false, err.message);
                return false;
            }
        }

        async function testTransactionQrCodesTable() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabaseClient
                    .from('transaction_qr_codes')
                    .select('id, merchant_id, qr_code_data, transaction_amount, reward_points, expires_at, is_used, used_by_loyalty_number, created_at, updated_at')
                    .limit(1);
                
                addResult('Transaction QR Codes Table Structure', !error, error ? error.message : 'All expected columns present');
                return !error;
            } catch (err) {
                addResult('Transaction QR Codes Table Structure', false, err.message);
                return false;
            }
        }

        async function testSchemaCompatibility() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test public schema
                const { data: publicLoyaltyData, error: publicLoyaltyError } = await supabaseClient
                    .from('loyalty_transactions')
                    .select('count')
                    .limit(1);

                const { data: publicQrData, error: publicQrError } = await supabaseClient
                    .from('transaction_qr_codes')
                    .select('count')
                    .limit(1);

                // Test api schema
                const { data: apiLoyaltyData, error: apiLoyaltyError } = await supabaseClient
                    .schema('api')
                    .from('loyalty_transactions')
                    .select('count')
                    .limit(1);

                const { data: apiQrData, error: apiQrError } = await supabaseClient
                    .schema('api')
                    .from('transaction_qr_codes')
                    .select('count')
                    .limit(1);

                const publicLoyaltyWorks = !publicLoyaltyError;
                const publicQrWorks = !publicQrError;
                const apiLoyaltyWorks = !apiLoyaltyError;
                const apiQrWorks = !apiQrError;
                
                addResult('Public Schema - Loyalty Transactions', publicLoyaltyWorks, publicLoyaltyError ? publicLoyaltyError.message : 'Accessible');
                addResult('Public Schema - Transaction QR Codes', publicQrWorks, publicQrError ? publicQrError.message : 'Accessible');
                addResult('API Schema - Loyalty Transactions', apiLoyaltyWorks, apiLoyaltyError ? apiLoyaltyError.message : 'Accessible');
                addResult('API Schema - Transaction QR Codes', apiQrWorks, apiQrError ? apiQrError.message : 'Accessible');
                
                return publicLoyaltyWorks || apiLoyaltyWorks;
            } catch (err) {
                addResult('Schema Compatibility', false, err.message);
                return false;
            }
        }

        async function testRLSPolicies() {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test loyalty_transactions RLS
                const { data: loyaltyData, error: loyaltyError } = await supabaseClient
                    .from('loyalty_transactions')
                    .select('*')
                    .limit(1);

                // Test transaction_qr_codes RLS
                const { data: qrData, error: qrError } = await supabaseClient
                    .from('transaction_qr_codes')
                    .select('*')
                    .limit(1);

                const loyaltyRLSWorking = !loyaltyError || loyaltyError.code === 'PGRST116';
                const qrRLSWorking = !qrError || qrError.code === 'PGRST116';
                
                addResult('RLS Policies - Loyalty Transactions', loyaltyRLSWorking, 
                    loyaltyError && loyaltyError.code !== 'PGRST116' ? `RLS Error: ${loyaltyError.message}` : 'RLS properly configured');
                
                addResult('RLS Policies - Transaction QR Codes', qrRLSWorking, 
                    qrError && qrError.code !== 'PGRST116' ? `RLS Error: ${qrError.message}` : 'RLS properly configured');
                
                return loyaltyRLSWorking && qrRLSWorking;
            } catch (err) {
                addResult('RLS Policies', false, err.message);
                return false;
            }
        }

        async function runTests() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Running Tests...';
            
            // Reset results
            testResults = { passed: 0, failed: 0, tests: [] };
            document.getElementById('results').innerHTML = '';
            
            console.log('üß™ Starting Transaction Tables Fix Tests');
            
            // Run all tests
            await testDatabaseConnection();
            await testLoyaltyTransactionsTable();
            await testTransactionQrCodesTable();
            await testSchemaCompatibility();
            await testRLSPolicies();
            
            // Update summary
            updateSummary();
            
            // Re-enable button
            testBtn.disabled = false;
            testBtn.textContent = 'Run Tests';
            
            console.log('üìä Test Results:', testResults);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').innerHTML = '';
            testResults = { passed: 0, failed: 0, tests: [] };
        }

        // Load Supabase client
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2';
        script.onload = () => {
            console.log('Supabase client loaded');
            updateSummary();
        };
        document.head.appendChild(script);
    </script>
</body>
</html>
